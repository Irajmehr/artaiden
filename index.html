<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Artin & Aiden ‚Ä¢ Behavior Tracker</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåü</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --sand-primary: #C9A882;
      --sand-light: #D4B996;
      --sand-lighter: #E5D4B7;
      --sand-warm: #A8916B;
      --sky-blue: #87CEEB;
      --fern-green: #4F7942;
      --sage-green: #6B8E4E;
      --slate: #4A4A4A;
      --cream: #FDF8F3;
      --danger: #B85C38;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: 16px; scroll-behavior: smooth; }
    body {
      font-family: 'Source Sans 3', -apple-system, sans-serif;
      background: linear-gradient(165deg, var(--cream) 0%, var(--sand-lighter) 50%, var(--sand-light) 100%);
      min-height: 100vh;
      color: var(--slate);
    }
    h1, h2, h3, h4 { font-family: 'Playfair Display', Georgia, serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--sand-lighter); border-radius: 3px; }
    ::-webkit-scrollbar-thumb { background: var(--sand-warm); border-radius: 3px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .spin { animation: spin 1s linear infinite; }
    .btn-bounce:active { transform: scale(0.92); }
    
    .mobile-nav { display: none; }
    
    @media (max-width: 1024px) {
      .three-panel { flex-direction: column !important; align-items: center !important; }
      .side-panel { min-width: 100% !important; max-width: 500px !important; width: 100% !important; }
      .center-panel { 
        order: -1 !important; 
        min-width: 100% !important;
        max-width: 500px !important;
        width: 100% !important;
      }
      .mobile-nav { 
        display: flex !important; 
        position: sticky;
        top: 52px;
        z-index: 99;
        background: white;
        padding: 10px 16px;
        gap: 8px;
        border-bottom: 1px solid #E5D4B7;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        justify-content: center;
      }
      .mobile-nav button {
        flex: 1;
        max-width: 140px;
        padding: 10px 12px;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
    }
    @media (max-width: 768px) { html { font-size: 14px; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxuEp2AwHSV3rN7D1Je1btpdtG1quMi6aaazCqqSxUJUq1rOfWzkXVb81Y2wnMQaC5O/exec';

const VIEWER_PASSWORD = 'artaiden';
const ADMIN_PASSWORD = '8006005';

// Icon Component
const Icon = ({ name, size = 20, color = 'currentColor' }) => {
  const ref = useRef(null);
  useEffect(() => {
    if (ref.current && lucide.icons[name]) {
      ref.current.innerHTML = '';
      const icon = lucide.createElement(lucide.icons[name]);
      icon.setAttribute('width', size);
      icon.setAttribute('height', size);
      icon.setAttribute('stroke', color);
      icon.setAttribute('stroke-width', '2');
      ref.current.appendChild(icon);
    }
  }, [name, size, color]);
  return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} />;
};

// Behaviors
const behaviorsByCategory = {
  'Punctuality': {
    icon: 'Clock', color: '#B8D4E8', textColor: '#2C3E50',
    items: [
      { id: 'wake', label: 'Waking up on time', posLabel: 'Woke up on time', negLabel: 'Woke up late', points: 10, icon: 'Sunrise' },
      { id: 'school-ready', label: 'Ready for school', posLabel: 'Ready on time', negLabel: 'Late for school', points: 10, icon: 'Backpack' },
      { id: 'homework-start', label: 'Starting homework', posLabel: 'Started on time', negLabel: 'Started late', points: 10, icon: 'PenLine' },
      { id: 'bed', label: 'Going to bed', posLabel: 'Bed on time', negLabel: 'Bed late', points: 10, icon: 'Moon' },
    ]
  },
  'Eating': {
    icon: 'Utensils', color: '#C9E4CA', textColor: '#2D5A2E',
    items: [
      { id: 'breakfast', label: 'Eating breakfast', posLabel: 'Ate breakfast', negLabel: 'Skipped breakfast', points: 10, icon: 'Coffee' },
      { id: 'lunch-school', label: 'Lunch at school', posLabel: 'Ate school lunch', negLabel: 'Skipped school lunch', points: 10, icon: 'Sandwich' },
      { id: 'snacks-school', label: 'School snacks', posLabel: 'Ate school snacks', negLabel: 'Skipped school snacks', points: 5, icon: 'Cookie' },
      { id: 'vegetables', label: 'Eating vegetables', posLabel: 'Ate vegetables', negLabel: 'Refused vegetables', points: 15, icon: 'Salad' },
      { id: 'fruits', label: 'Eating fruits', posLabel: 'Ate fruits', negLabel: 'Refused fruits', points: 10, icon: 'Apple' },
      { id: 'finish-meal', label: 'Finishing meal', posLabel: 'Finished meal', negLabel: 'Did not finish', points: 10, icon: 'UtensilsCrossed' },
    ]
  },
  'Learning': {
    icon: 'GraduationCap', color: '#E8D4B8', textColor: '#5A4A2D',
    items: [
      { id: 'homework', label: 'Completing homework', posLabel: 'Completed homework', negLabel: 'Incomplete homework', points: 15, icon: 'BookOpen' },
      { id: 'reading', label: 'Reading (20 min)', posLabel: 'Read 20 minutes', negLabel: 'Did not read', points: 15, icon: 'BookMarked' },
      { id: 'book-chapter', label: 'Finish book chapter', posLabel: 'Finished chapter', negLabel: 'Did not finish', points: 20, icon: 'BookCheck' },
    ]
  },
  'Character': {
    icon: 'Heart', color: '#E8B8D4', textColor: '#5A2D4A',
    items: [
      { id: 'kind-words', label: 'Kind words', posLabel: 'Used kind words', negLabel: 'Unkind words', points: 5, icon: 'MessageCircleHeart' },
      { id: 'sharing', label: 'Sharing', posLabel: 'Shared nicely', negLabel: 'Did not share', points: 10, icon: 'Users' },
      { id: 'manners', label: 'Good manners', posLabel: 'Good manners', negLabel: 'Bad manners', points: 5, icon: 'Sparkles' },
      { id: 'helping', label: 'Helping', posLabel: 'Helped voluntarily', negLabel: 'Refused to help', points: 15, icon: 'HandHelping' },
      { id: 'no-fighting', label: 'No fighting', posLabel: 'No fighting today', negLabel: 'Fought with sibling', points: 10, icon: 'Swords' },
      { id: 'respect', label: 'Being respectful', posLabel: 'Was respectful', negLabel: 'Talked back', points: 10, icon: 'MessageSquare' },
    ]
  },
  'Responsibility': {
    icon: 'CheckSquare', color: '#D4B8E8', textColor: '#4A2D5A',
    items: [
      { id: 'chores', label: 'Doing chores', posLabel: 'Did chores', negLabel: 'Skipped chores', points: 10, icon: 'Brush' },
      { id: 'basketball', label: 'Basketball', posLabel: 'Attended basketball', negLabel: 'Skipped basketball', points: 15, icon: 'Dribbble' },
      { id: 'clean-room', label: 'Clean room', posLabel: 'Cleaned room', negLabel: 'Messy room', points: 10, icon: 'Home' },
    ]
  },
  'Screen Time': {
    icon: 'Smartphone', color: '#FFE4E4', textColor: '#8B3A3A',
    items: [
      { id: 'no-youtube', label: 'No YouTube shorts', posLabel: 'No YouTube shorts', negLabel: 'Watched YouTube shorts', points: 5, icon: 'Youtube' },
      { id: 'screen-limit', label: 'Screen limit', posLabel: 'Within screen limit', negLabel: 'Exceeded screen time', points: 10, icon: 'MonitorOff' },
    ]
  }
};

const rewards = [
  { id: 'game15', points: 20, label: '15 min Game Time', icon: 'Gamepad2' },
  { id: 'tv30', points: 30, label: '30 min TV Time', icon: 'Tv' },
  { id: 'game30', points: 35, label: '30 min Game Time', icon: 'Gamepad' },
  { id: 'snack', points: 40, label: 'Special Snack', icon: 'Popcorn' },
  { id: 'movie', points: 50, label: 'Movie Night', icon: 'Film' },
  { id: 'stayup', points: 60, label: 'Stay Up Late', icon: 'MoonStar' },
  { id: 'game60', points: 75, label: '1 Hour Game', icon: 'Trophy' },
  { id: 'wish', points: 100, label: 'Free Wish', icon: 'Star' },
  { id: 'boss', points: 150, label: 'Boss of Home', icon: 'Crown' },
  { id: 'outing', points: 200, label: 'Special Outing', icon: 'PartyPopper' },
];

const restrictions = [
  { threshold: 0, label: 'No Games', icon: 'Gamepad2' },
  { threshold: -10, label: 'No TV', icon: 'Tv' },
  { threshold: -20, label: 'No YouTube', icon: 'Youtube' },
  { threshold: -30, label: 'Early Bed', icon: 'Moon' },
];

// Utilities
const getColor = s => s >= 100 ? '#4F7942' : s >= 50 ? '#6B8E4E' : s >= 20 ? '#87CEEB' : s >= 0 ? '#C9A882' : s >= -20 ? '#D4966B' : '#B85C38';
const today = () => new Date().toISOString().split('T')[0];
const formatDate = () => new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
const getWeekStart = () => {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  d.setDate(d.getDate() - d.getDay());
  return d.toISOString().split('T')[0];
};

// Calculate scores from history (single source of truth)
const calculateScores = (history) => {
  const scores = { Artin: 0, Aiden: 0 };
  ['Artin', 'Aiden'].forEach(name => {
    scores[name] = (history[name] || []).reduce((sum, h) => sum + h.points, 0);
  });
  return scores;
};

// Calculate weekly scores from history
const calculateWeeklyScores = (history) => {
  const weekStart = getWeekStart();
  const scores = { Artin: 0, Aiden: 0 };
  ['Artin', 'Aiden'].forEach(name => {
    scores[name] = (history[name] || [])
      .filter(h => h.date >= weekStart)
      .reduce((sum, h) => sum + h.points, 0);
  });
  return scores;
};

// Calculate today's scores from history
const calculateTodayScores = (history) => {
  const todayStr = today();
  const scores = { Artin: 0, Aiden: 0 };
  ['Artin', 'Aiden'].forEach(name => {
    scores[name] = (history[name] || [])
      .filter(h => h.date === todayStr)
      .reduce((sum, h) => sum + h.points, 0);
  });
  return scores;
};

// Build daily states from history
const buildDailyStates = (history) => {
  const todayStr = today();
  const states = { Artin: {}, Aiden: {} };
  ['Artin', 'Aiden'].forEach(name => {
    const todayHistory = (history[name] || []).filter(h => h.date === todayStr);
    todayHistory.forEach(h => {
      if (h.behaviorId) {
        states[name][h.behaviorId] = h.type;
      }
    });
  });
  return states;
};

// API
const api = {
  async getData() {
    try {
      const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
      return res.json();
    } catch (e) {
      const saved = localStorage.getItem('bt_data_v8');
      return saved ? JSON.parse(saved) : null;
    }
  },
  async recordBehavior(child, behavior) {
    try { return fetch(GOOGLE_SCRIPT_URL + '?action=recordBehavior', { method: 'POST', body: JSON.stringify({ child, behavior }) }).then(r => r.json()); }
    catch (e) { return { success: true }; }
  },
  async undoLast(child) {
    try { return fetch(GOOGLE_SCRIPT_URL + '?action=undoLast', { method: 'POST', body: JSON.stringify({ child }) }).then(r => r.json()); }
    catch (e) { return { success: true }; }
  },
  async resetChild(child) {
    try { return fetch(GOOGLE_SCRIPT_URL + '?action=resetChild', { method: 'POST', body: JSON.stringify({ child }) }).then(r => r.json()); }
    catch (e) { return { success: true }; }
  }
};

// Password Screen
function PasswordScreen({ onUnlock }) {
  const [pw, setPw] = useState('');
  const [err, setErr] = useState(false);
  
  const submit = e => { 
    e.preventDefault(); 
    if (pw === ADMIN_PASSWORD) {
      localStorage.setItem('bt_auth', 'admin');
      onUnlock('admin');
    } else if (pw === VIEWER_PASSWORD) {
      localStorage.setItem('bt_auth', 'viewer');
      onUnlock('viewer');
    } else {
      setErr(true);
      setTimeout(() => setErr(false), 2000);
    }
  };
  
  return (
    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20 }}>
      <div className="fade-in" style={{ background: 'white', borderRadius: 20, padding: '40px 32px', boxShadow: '0 16px 48px rgba(74,74,74,0.15)', textAlign: 'center', maxWidth: 380, width: '100%', border: '1px solid #E5D4B7' }}>
        <div style={{ width: 72, height: 72, borderRadius: '50%', background: 'linear-gradient(135deg, #C9A882 0%, #A8916B 100%)', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px' }}>
          <Icon name="Lock" size={32} color="white" />
        </div>
        <h1 style={{ margin: '0 0 6px', color: '#4A4A4A', fontSize: '1.75rem' }}>Behavior Tracker</h1>
        <p style={{ color: '#6B7280', marginBottom: 24 }}>Enter password to continue</p>
        <form onSubmit={submit}>
          <input type="password" value={pw} onChange={e => setPw(e.target.value)} placeholder="Password" style={{ width: '100%', padding: '14px 18px', borderRadius: 10, border: `2px solid ${err ? '#B85C38' : '#E5D4B7'}`, fontSize: '1rem', marginBottom: 16, outline: 'none', background: '#FDFBF9' }} />
          {err && <p style={{ color: '#B85C38', marginBottom: 12, fontSize: '0.9rem' }}>Incorrect password</p>}
          <button type="submit" style={{ width: '100%', padding: '14px', borderRadius: 10, border: 'none', background: 'linear-gradient(135deg, #4F7942 0%, #6B8E4E 100%)', color: 'white', fontSize: '1rem', fontWeight: 600, cursor: 'pointer' }}>Enter</button>
        </form>
        <div style={{ marginTop: 20, padding: 16, background: '#F9F6F2', borderRadius: 10, textAlign: 'left' }}>
          <p style={{ fontSize: '0.8rem', color: '#888', margin: 0 }}>
            <strong style={{ color: '#4A4A4A' }}>üë¶ Kids:</strong> View your progress<br/>
            <strong style={{ color: '#4A4A4A' }}>üë® Dad:</strong> Edit behaviors & manage scores
          </p>
        </div>
      </div>
    </div>
  );
}

// Avatar
function Avatar({ name, avatar, onUpload, size = 80, isAdmin }) {
  const inputRef = useRef(null);
  const handleUpload = (e) => {
    if (!isAdmin) return;
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => onUpload(name, reader.result);
      reader.readAsDataURL(file);
    }
  };

  return (
    <div style={{ position: 'relative', width: size, height: size, margin: '0 auto' }}>
      <div onClick={() => isAdmin && inputRef.current?.click()} style={{
        width: size, height: size, borderRadius: '50%', overflow: 'hidden',
        background: avatar ? 'none' : 'linear-gradient(135deg, #C9A882 0%, #A8916B 100%)',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        cursor: isAdmin ? 'pointer' : 'default', border: '3px solid white', boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
      }}>
        {avatar ? <img src={avatar} alt={name} style={{ width: '100%', height: '100%', objectFit: 'cover' }} /> : <Icon name="User" size={size * 0.45} color="white" />}
      </div>
      {isAdmin && (
        <div style={{ position: 'absolute', bottom: 0, right: 0, width: 28, height: 28, borderRadius: '50%', background: '#4F7942', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '2px solid white', cursor: 'pointer' }} onClick={() => inputRef.current?.click()}>
          <Icon name="Camera" size={14} color="white" />
        </div>
      )}
      <input ref={inputRef} type="file" accept="image/*" onChange={handleUpload} style={{ display: 'none' }} />
    </div>
  );
}

// Behavior Row
function BehaviorRow({ item, dailyState, onAdd, onSubtract, loading, isAdmin }) {
  const state = dailyState || null;
  
  return (
    <div style={{ 
      display: 'flex', alignItems: 'center', gap: 8, padding: '8px 4px', 
      borderBottom: '1px solid #E5D4B7',
      background: state === 'positive' ? '#F0FDF4' : state === 'negative' ? '#FEF2F2' : 'transparent',
      borderRadius: state ? 8 : 0, marginBottom: 2
    }}>
      {isAdmin ? (
        <button onClick={() => onSubtract(item)} disabled={loading || state === 'negative'} className="btn-bounce" style={{
          width: 36, height: 36, borderRadius: 10, border: 'none',
          background: state === 'negative' ? '#B85C38' : 'linear-gradient(135deg, #B85C38 0%, #D4714D 100%)',
          color: 'white', cursor: loading || state === 'negative' ? 'default' : 'pointer',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          opacity: state === 'negative' ? 1 : state === 'positive' ? 0.4 : 1,
          boxShadow: state === 'negative' ? 'none' : '0 2px 8px rgba(184,92,56,0.25)', flexShrink: 0
        }}>
          {state === 'negative' ? <Icon name="Check" size={18} color="white" /> : <Icon name="Minus" size={18} color="white" />}
        </button>
      ) : (
        <div style={{ width: 28, height: 28, borderRadius: 8, flexShrink: 0, background: state === 'negative' ? '#B85C38' : '#E5D4B7', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          {state === 'negative' ? <Icon name="X" size={14} color="white" /> : <Icon name="Minus" size={14} color="#aaa" />}
        </div>
      )}

      <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: 8, minWidth: 0 }}>
        <div style={{ width: 32, height: 32, borderRadius: 8, background: state === 'positive' ? '#4F7942' : state === 'negative' ? '#B85C38' : '#F5F0EB', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>
          <Icon name={item.icon} size={16} color={state ? 'white' : '#A8916B'} />
        </div>
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{ fontWeight: 600, color: state === 'positive' ? '#4F7942' : state === 'negative' ? '#B85C38' : '#4A4A4A', fontSize: '0.85rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
            {state === 'positive' ? item.posLabel : state === 'negative' ? item.negLabel : item.label}
          </div>
          <div style={{ fontSize: '0.7rem', color: '#888' }}>¬±{item.points} pts</div>
        </div>
      </div>

      {isAdmin ? (
        <button onClick={() => onAdd(item)} disabled={loading || state === 'positive'} className="btn-bounce" style={{
          width: 36, height: 36, borderRadius: 10, border: 'none',
          background: state === 'positive' ? '#4F7942' : 'linear-gradient(135deg, #4F7942 0%, #6B8E4E 100%)',
          color: 'white', cursor: loading || state === 'positive' ? 'default' : 'pointer',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          opacity: state === 'positive' ? 1 : state === 'negative' ? 0.4 : 1,
          boxShadow: state === 'positive' ? 'none' : '0 2px 8px rgba(79,121,66,0.25)', flexShrink: 0
        }}>
          {state === 'positive' ? <Icon name="Check" size={18} color="white" /> : <Icon name="Plus" size={18} color="white" />}
        </button>
      ) : (
        <div style={{ width: 28, height: 28, borderRadius: 8, flexShrink: 0, background: state === 'positive' ? '#4F7942' : '#E5D4B7', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          {state === 'positive' ? <Icon name="Check" size={14} color="white" /> : <Icon name="Plus" size={14} color="#aaa" />}
        </div>
      )}
    </div>
  );
}

// Weekly Chart
function WeeklyChart({ history, name }) {
  const days = useMemo(() => {
    const result = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      const dayHistory = (history[name] || []).filter(h => h.date === dateStr);
      const points = dayHistory.reduce((sum, h) => sum + h.points, 0);
      result.push({ day: d.toLocaleDateString('en-US', { weekday: 'short' }), points, isToday: i === 0 });
    }
    return result;
  }, [history, name]);
  
  const maxAbs = Math.max(50, ...days.map(d => Math.abs(d.points)));
  
  return (
    <div style={{ padding: 16 }}>
      <h4 style={{ margin: '0 0 12px', fontSize: '0.9rem', color: '#4A4A4A', textAlign: 'center' }}>{name}'s Week</h4>
      <div style={{ display: 'flex', alignItems: 'end', justifyContent: 'space-between', height: 100, gap: 4 }}>
        {days.map((d, i) => (
          <div key={i} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', flex: 1 }}>
            <div style={{ 
              width: '100%', maxWidth: 30, 
              height: Math.max(4, Math.abs(d.points) / maxAbs * 60),
              background: d.points >= 0 ? '#4F7942' : '#B85C38',
              borderRadius: 4, marginBottom: 4, opacity: d.isToday ? 1 : 0.7
            }} />
            <span style={{ fontSize: '0.65rem', color: d.isToday ? '#4A4A4A' : '#888', fontWeight: d.isToday ? 600 : 400 }}>{d.day}</span>
            <span style={{ fontSize: '0.6rem', color: d.points >= 0 ? '#4F7942' : '#B85C38' }}>{d.points >= 0 ? '+' : ''}{d.points}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// Score Summary
function ScoreSummary({ scores, weeklyScores }) {
  return (
    <div style={{ padding: 16, background: '#F9F6F2', borderRadius: 12, marginBottom: 16 }}>
      <h4 style={{ margin: '0 0 16px', fontSize: '1rem', color: '#4A4A4A', textAlign: 'center' }}>Score Comparison</h4>
      <div style={{ display: 'flex', justifyContent: 'space-around' }}>
        {['Artin', 'Aiden'].map(name => (
          <div key={name} style={{ textAlign: 'center' }}>
            <div style={{ fontSize: '2rem', fontWeight: 700, color: getColor(scores[name] || 0) }}>{scores[name] || 0}</div>
            <div style={{ fontSize: '0.8rem', color: '#888' }}>{name}</div>
            <div style={{ fontSize: '0.7rem', color: '#aaa', marginTop: 4 }}>Week: {weeklyScores[name] || 0}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// Category Progress - uses dailyStates for consistency
function CategoryProgress({ dailyStates, name }) {
  const childState = dailyStates[name] || {};
  
  const catStats = useMemo(() => {
    return Object.entries(behaviorsByCategory).map(([catName, cat]) => {
      const total = cat.items.length;
      const positive = cat.items.filter(item => childState[item.id] === 'positive').length;
      const negative = cat.items.filter(item => childState[item.id] === 'negative').length;
      return { name: catName, total, positive, negative, completed: positive + negative };
    });
  }, [childState]);

  return (
    <div style={{ padding: 16 }}>
      <h4 style={{ margin: '0 0 12px', fontSize: '0.9rem', color: '#4A4A4A', textAlign: 'center' }}>{name}'s Today</h4>
      <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
        {catStats.map(cat => (
          <div key={cat.name} style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            <span style={{ fontSize: '0.7rem', color: '#888', width: 70, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{cat.name}</span>
            <div style={{ flex: 1, height: 8, background: '#E5D4B7', borderRadius: 4, overflow: 'hidden', display: 'flex' }}>
              <div style={{ width: `${(cat.positive / cat.total) * 100}%`, height: '100%', background: '#4F7942' }} />
              <div style={{ width: `${(cat.negative / cat.total) * 100}%`, height: '100%', background: '#B85C38' }} />
            </div>
            <span style={{ fontSize: '0.65rem', color: '#888', width: 30 }}>{cat.completed}/{cat.total}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// Child Panel
function ChildPanel({ name, scores, weeklyScores, todayScores, history, dailyStates, avatar, onRecord, onUndo, onReset, onAvatarUpload, loading, isAdmin, panelId }) {
  const score = scores[name] || 0;
  const weeklyScore = weeklyScores[name] || 0;
  const todayScore = todayScores[name] || 0;
  const childHistory = history[name] || [];
  const childDailyState = dailyStates[name] || {};
  const activeRestrictions = restrictions.filter(r => score <= r.threshold);
  const hasRestrictions = activeRestrictions.length > 0;
  const [expandedCat, setExpandedCat] = useState('Punctuality');

  const handleAdd = (item) => {
    onRecord(name, { id: item.id + '-pos', label: item.posLabel, points: item.points, type: 'positive', behaviorId: item.id });
  };

  const handleSubtract = (item) => {
    onRecord(name, { id: item.id + '-neg', label: item.negLabel, points: -item.points, type: 'negative', behaviorId: item.id });
  };

  return (
    <div id={panelId} className="fade-in side-panel" style={{ 
      background: 'white', borderRadius: 20, 
      boxShadow: '0 8px 32px rgba(74,74,74,0.1)', 
      border: hasRestrictions ? '3px solid #B85C38' : '1px solid #E5D4B7',
      overflow: 'hidden', minWidth: 340, maxWidth: 400, flex: 1
    }}>
      <div style={{ background: `linear-gradient(135deg, ${getColor(score)} 0%, ${getColor(score)}dd 100%)`, padding: '20px 16px', textAlign: 'center', color: 'white' }}>
        <Avatar name={name} avatar={avatar} onUpload={onAvatarUpload} size={70} isAdmin={isAdmin} />
        <h2 style={{ margin: '10px 0 4px', fontSize: '1.4rem', fontWeight: 600 }}>{name}</h2>
        <div style={{ fontSize: '2.2rem', fontWeight: 700 }}>{score}</div>
        <div style={{ fontSize: '0.85rem', opacity: 0.9 }}>points total</div>
        <div style={{ marginTop: 8, display: 'flex', justifyContent: 'center', gap: 16, fontSize: '0.8rem' }}>
          <span style={{ background: 'rgba(255,255,255,0.2)', padding: '4px 12px', borderRadius: 12 }}>
            Today: <strong style={{ color: todayScore >= 0 ? '#fff' : '#ffcccc' }}>{todayScore >= 0 ? '+' : ''}{todayScore}</strong>
          </span>
          <span style={{ background: 'rgba(255,255,255,0.2)', padding: '4px 12px', borderRadius: 12 }}>
            Week: <strong style={{ color: weeklyScore >= 0 ? '#fff' : '#ffcccc' }}>{weeklyScore >= 0 ? '+' : ''}{weeklyScore}</strong>
          </span>
        </div>
        {!isAdmin && (
          <div style={{ marginTop: 10, padding: '6px 12px', background: 'rgba(255,255,255,0.2)', borderRadius: 8, fontSize: '0.75rem', display: 'inline-flex', alignItems: 'center', gap: 6 }}>
            <Icon name="Eye" size={12} color="white" /> View Only
          </div>
        )}
      </div>

      <div style={{ padding: 12 }}>
        {hasRestrictions && (
          <div style={{ background: '#FEF2F2', border: '1px solid #FECACA', borderRadius: 10, padding: 10, marginBottom: 12 }}>
            <div style={{ fontWeight: 600, color: '#B85C38', marginBottom: 4, fontSize: '0.8rem', display: 'flex', alignItems: 'center', gap: 4 }}>
              <Icon name="AlertTriangle" size={14} color="#B85C38" /> Restrictions Active
            </div>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 4 }}>
              {activeRestrictions.map(r => (<span key={r.threshold} style={{ padding: '3px 8px', background: 'white', borderRadius: 6, color: '#B85C38', fontSize: '0.7rem', fontWeight: 500 }}>{r.label}</span>))}
            </div>
          </div>
        )}

        {score >= 20 && !hasRestrictions && (
          <div style={{ background: '#FEF7ED', border: '1px solid #FCD9B6', borderRadius: 10, padding: 10, marginBottom: 12 }}>
            <div style={{ fontWeight: 600, color: '#92400E', marginBottom: 4, fontSize: '0.8rem', display: 'flex', alignItems: 'center', gap: 4 }}>
              <Icon name="Gift" size={14} color="#C9A882" /> Rewards Available!
            </div>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 4 }}>
              {rewards.filter(r => score >= r.points).slice(0, 3).map(r => (<span key={r.id} style={{ padding: '3px 8px', background: 'white', borderRadius: 6, color: '#92400E', fontSize: '0.7rem', fontWeight: 500 }}>{r.label}</span>))}
            </div>
          </div>
        )}

        <div style={{ maxHeight: 380, overflowY: 'auto' }}>
          {Object.entries(behaviorsByCategory).map(([catName, cat]) => {
            const completedCount = cat.items.filter(item => childDailyState[item.id]).length;
            return (
              <div key={catName} style={{ marginBottom: 8 }}>
                <button onClick={() => setExpandedCat(expandedCat === catName ? null : catName)} style={{ width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '8px 12px', background: cat.color, borderRadius: 8, border: 'none', cursor: 'pointer' }}>
                  <span style={{ display: 'flex', alignItems: 'center', gap: 6, fontWeight: 600, color: cat.textColor, fontSize: '0.85rem' }}>
                    <Icon name={cat.icon} size={16} color={cat.textColor} />{catName}
                  </span>
                  <span style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                    <span style={{ fontSize: '0.75rem', color: cat.textColor, opacity: 0.8 }}>{completedCount}/{cat.items.length}</span>
                    <Icon name={expandedCat === catName ? 'ChevronUp' : 'ChevronDown'} size={16} color={cat.textColor} />
                  </span>
                </button>
                {expandedCat === catName && (
                  <div style={{ paddingTop: 6 }}>
                    {cat.items.map(item => (<BehaviorRow key={item.id} item={item} dailyState={childDailyState[item.id]} onAdd={handleAdd} onSubtract={handleSubtract} loading={loading} isAdmin={isAdmin} />))}
                  </div>
                )}
              </div>
            );
          })}
        </div>

        {isAdmin && (
          <div style={{ display: 'flex', gap: 8, marginTop: 12 }}>
            <button onClick={() => onUndo(name)} disabled={!childHistory.length || loading} style={{ flex: 1, padding: 10, borderRadius: 10, border: '2px dashed #D4B996', background: childHistory.length ? 'white' : '#F5F5F5', color: childHistory.length ? '#6B7280' : '#B0B0B0', cursor: childHistory.length ? 'pointer' : 'not-allowed', fontSize: '0.8rem', fontWeight: 500, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}>
              <Icon name="Undo2" size={14} /> Undo
            </button>
            <button onClick={() => onReset(name)} style={{ flex: 1, padding: 10, borderRadius: 10, border: 'none', background: '#FEF2F2', color: '#B85C38', fontSize: '0.8rem', fontWeight: 500, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}>
              <Icon name="RotateCcw" size={14} /> Reset
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

// Center Panel
function CenterPanel({ scores, weeklyScores, history, dailyStates, claimed }) {
  const [view, setView] = useState('charts');
  
  return (
    <div id="center-panel" className="fade-in center-panel" style={{ flex: 1, minWidth: 280, maxWidth: 400, display: 'flex', flexDirection: 'column', gap: 16 }}>
      <div style={{ background: 'white', borderRadius: 16, padding: 16, textAlign: 'center', boxShadow: '0 4px 16px rgba(74,74,74,0.08)', border: '1px solid #E5D4B7' }}>
        <div style={{ fontSize: '0.8rem', color: '#888', marginBottom: 4 }}>Today is</div>
        <div style={{ fontSize: '1.2rem', fontWeight: 600, color: '#4A4A4A' }}>{formatDate()}</div>
      </div>

      <div style={{ display: 'flex', gap: 8 }}>
        {[['charts', 'BarChart3', 'Charts'], ['rewards', 'Gift', 'Rewards']].map(([v, icon, label]) => (
          <button key={v} onClick={() => setView(v)} style={{ flex: 1, padding: '10px', borderRadius: 10, border: view === v ? 'none' : '1px solid #D4B996', background: view === v ? '#4F7942' : 'white', color: view === v ? 'white' : '#4A4A4A', fontSize: '0.85rem', fontWeight: 600, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}>
            <Icon name={icon} size={16} color={view === v ? 'white' : '#4F7942'} /> {label}
          </button>
        ))}
      </div>

      {view === 'charts' && (
        <div style={{ background: 'white', borderRadius: 16, overflow: 'hidden', boxShadow: '0 4px 16px rgba(74,74,74,0.08)', border: '1px solid #E5D4B7' }}>
          <ScoreSummary scores={scores} weeklyScores={weeklyScores} />
          <div style={{ borderTop: '1px solid #E5D4B7' }}><WeeklyChart history={history} name="Artin" /></div>
          <div style={{ borderTop: '1px solid #E5D4B7' }}><WeeklyChart history={history} name="Aiden" /></div>
          <div style={{ borderTop: '1px solid #E5D4B7' }}><CategoryProgress dailyStates={dailyStates} name="Artin" /></div>
          <div style={{ borderTop: '1px solid #E5D4B7' }}><CategoryProgress dailyStates={dailyStates} name="Aiden" /></div>
        </div>
      )}

      {view === 'rewards' && (
        <div style={{ background: 'white', borderRadius: 16, padding: 16, boxShadow: '0 4px 16px rgba(74,74,74,0.08)', border: '1px solid #E5D4B7', maxHeight: 500, overflowY: 'auto' }}>
          {['Artin', 'Aiden'].map(name => (
            <div key={name} style={{ marginBottom: 20 }}>
              <h4 style={{ margin: '0 0 10px', fontSize: '1rem', color: '#4A4A4A' }}>{name}'s Rewards</h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                {rewards.map(r => {
                  const can = (scores[name] || 0) >= r.points;
                  const done = (claimed[name] || []).includes(r.id);
                  return (
                    <div key={r.id} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '8px 10px', borderRadius: 8, background: done ? '#E8F5E9' : can ? '#FEF7ED' : '#F5F5F5', border: `1px solid ${done ? '#4F7942' : can ? '#C9A882' : '#E5E5E5'}` }}>
                      <div style={{ width: 28, height: 28, borderRadius: 6, background: done ? '#4F7942' : can ? '#C9A882' : '#D4D4D4', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name={r.icon} size={14} color="white" />
                      </div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 600, color: '#4A4A4A', fontSize: '0.8rem' }}>{r.label}</div>
                        <div style={{ fontSize: '0.7rem', color: '#888' }}>{r.points} pts</div>
                      </div>
                      {done && <Icon name="Check" size={16} color="#4F7942" />}
                      {!done && can && <span style={{ fontSize: '0.7rem', color: '#4F7942', fontWeight: 600 }}>‚úì Available</span>}
                      {!done && !can && <span style={{ fontSize: '0.7rem', color: '#999' }}>{r.points - (scores[name] || 0)} more</span>}
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      )}

      <div style={{ background: 'white', borderRadius: 16, padding: 16, boxShadow: '0 4px 16px rgba(74,74,74,0.08)', border: '1px solid #E5D4B7' }}>
        <h4 style={{ margin: '0 0 12px', fontSize: '0.9rem', color: '#4A4A4A', textAlign: 'center' }}>Weekly Goal: 150 pts</h4>
        {['Artin', 'Aiden'].map(name => {
          const score = weeklyScores[name] || 0;
          const pct = Math.min(100, Math.max(0, (score / 150) * 100));
          return (
            <div key={name} style={{ marginBottom: 10 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                <span style={{ fontSize: '0.8rem', fontWeight: 600, color: '#4A4A4A' }}>{name}</span>
                <span style={{ fontSize: '0.8rem', color: score >= 0 ? '#4F7942' : '#B85C38' }}>{score}/150 {score >= 150 && 'üéâ'}</span>
              </div>
              <div style={{ height: 10, background: '#E5D4B7', borderRadius: 5, overflow: 'hidden' }}>
                <div style={{ width: `${pct}%`, height: '100%', background: getColor(score), borderRadius: 5, transition: 'width 0.3s' }} />
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// Mobile Nav
function MobileNav({ avatars }) {
  const scrollTo = (id) => document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  return (
    <div className="mobile-nav">
      <button onClick={() => scrollTo('artin-panel')} style={{ background: 'linear-gradient(135deg, #87CEEB 0%, #6BB8D9 100%)', color: '#2C3E50' }}>
        {avatars.Artin ? <img src={avatars.Artin} alt="Artin" style={{ width: 24, height: 24, borderRadius: '50%', objectFit: 'cover' }} /> : <Icon name="User" size={18} color="#2C3E50" />}
        Artin
      </button>
      <button onClick={() => scrollTo('center-panel')} style={{ background: 'linear-gradient(135deg, #C9A882 0%, #A8916B 100%)', color: 'white' }}>
        <Icon name="BarChart3" size={18} color="white" /> Charts
      </button>
      <button onClick={() => scrollTo('aiden-panel')} style={{ background: 'linear-gradient(135deg, #4F7942 0%, #6B8E4E 100%)', color: 'white' }}>
        {avatars.Aiden ? <img src={avatars.Aiden} alt="Aiden" style={{ width: 24, height: 24, borderRadius: '50%', objectFit: 'cover' }} /> : <Icon name="User" size={18} color="white" />}
        Aiden
      </button>
    </div>
  );
}

// Main App
function App() {
  const [authMode, setAuthMode] = useState(() => localStorage.getItem('bt_auth'));
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [history, setHistory] = useState({ Artin: [], Aiden: [] });
  const [claimed, setClaimed] = useState({ Artin: [], Aiden: [] });
  const [avatars, setAvatars] = useState({ Artin: null, Aiden: null });

  const isAdmin = authMode === 'admin';

  // Derive all scores from history (single source of truth)
  const scores = useMemo(() => calculateScores(history), [history]);
  const weeklyScores = useMemo(() => calculateWeeklyScores(history), [history]);
  const todayScores = useMemo(() => calculateTodayScores(history), [history]);
  const dailyStates = useMemo(() => buildDailyStates(history), [history]);

  useEffect(() => { if (authMode) loadData(); }, [authMode]);

  const loadData = async () => {
    setLoading(true);
    
    // Load avatars
    const savedAvatars = localStorage.getItem('bt_avatars');
    if (savedAvatars) setAvatars(JSON.parse(savedAvatars));

    try {
      const data = await api.getData();
      if (data && data.history) {
        setHistory(data.history);
        setClaimed(data.claimed || { Artin: [], Aiden: [] });
      } else {
        // Fallback to localStorage
        const saved = localStorage.getItem('bt_data_v8');
        if (saved) {
          const localData = JSON.parse(saved);
          setHistory(localData.history || { Artin: [], Aiden: [] });
          setClaimed(localData.claimed || { Artin: [], Aiden: [] });
        }
      }
    } catch (e) { 
      console.error('Load error:', e);
      const saved = localStorage.getItem('bt_data_v8');
      if (saved) {
        const localData = JSON.parse(saved);
        setHistory(localData.history || { Artin: [], Aiden: [] });
        setClaimed(localData.claimed || { Artin: [], Aiden: [] });
      }
    }
    setLoading(false);
  };

  // Save to localStorage whenever history changes
  useEffect(() => {
    if (authMode && !loading) {
      localStorage.setItem('bt_data_v8', JSON.stringify({ history, claimed }));
    }
  }, [history, claimed, authMode, loading]);

  const handleAvatarUpload = (name, dataUrl) => {
    if (!isAdmin) return;
    const newAvatars = { ...avatars, [name]: dataUrl };
    setAvatars(newAvatars);
    localStorage.setItem('bt_avatars', JSON.stringify(newAvatars));
  };

  const record = async (child, behavior) => {
    if (!isAdmin) return;
    
    // Check if already recorded today
    const currentDailyStates = buildDailyStates(history);
    if (currentDailyStates[child]?.[behavior.behaviorId]) return;

    setSaving(true);
    const entry = { ...behavior, timestamp: new Date().toISOString(), date: today() };
    
    setHistory(h => ({ ...h, [child]: [entry, ...h[child]] }));

    try { await api.recordBehavior(child, behavior); } catch (e) { console.error(e); }
    setSaving(false);
  };

  const undo = async (child) => {
    if (!isAdmin || !history[child]?.length) return;
    setSaving(true);
    
    setHistory(h => ({ ...h, [child]: h[child].slice(1) }));

    try { await api.undoLast(child); } catch (e) { console.error(e); }
    setSaving(false);
  };

  const resetChild = async (child) => {
    if (!isAdmin) return;
    if (!confirm(`Reset ${child}'s score and history? This cannot be undone.`)) return;
    
    setHistory(h => ({ ...h, [child]: [] }));
    setClaimed(c => ({ ...c, [child]: [] }));

    try { await api.resetChild(child); } catch (e) { console.error(e); }
  };

  const logout = () => { localStorage.removeItem('bt_auth'); setAuthMode(null); };

  if (!authMode) return <PasswordScreen onUnlock={(mode) => setAuthMode(mode)} />;
  
  if (loading) return (
    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
      <div style={{ textAlign: 'center' }}>
        <span className="spin" style={{ display: 'inline-block' }}><Icon name="Loader2" size={48} color="#C9A882" /></span>
        <p style={{ marginTop: 16, color: '#888' }}>Loading...</p>
      </div>
    </div>
  );

  return (
    <div style={{ minHeight: '100vh' }}>
      <header style={{ 
        background: isAdmin ? 'linear-gradient(135deg, #4F7942 0%, #6B8E4E 100%)' : 'linear-gradient(135deg, #87CEEB 0%, #6BB8D9 100%)', 
        padding: '12px 20px', color: isAdmin ? 'white' : '#2C3E50', 
        display: 'flex', justifyContent: 'space-between', alignItems: 'center',
        position: 'sticky', top: 0, zIndex: 100
      }}>
        <div>
          <h1 style={{ margin: 0, fontSize: '1.2rem', display: 'flex', alignItems: 'center', gap: 8 }}>
            {isAdmin ? <Icon name="Shield" size={18} /> : <Icon name="Eye" size={18} />}
            Behavior Tracker
          </h1>
          <div style={{ fontSize: '0.7rem', opacity: 0.9, marginTop: 2 }}>
            {isAdmin ? 'üë® Admin Mode' : 'üë¶ Viewer Mode'}
            {saving && ' ‚Ä¢ üíæ Saving...'}
          </div>
        </div>
        <button onClick={logout} style={{ padding: '8px 14px', borderRadius: 8, border: 'none', background: 'rgba(255,255,255,0.2)', color: isAdmin ? 'white' : '#2C3E50', fontSize: '0.85rem', fontWeight: 500, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6 }}>
          <Icon name="LogOut" size={16} /> Lock
        </button>
      </header>

      <MobileNav avatars={avatars} />

      <main className="three-panel" style={{ display: 'flex', gap: 20, padding: 20, maxWidth: 1400, margin: '0 auto', alignItems: 'flex-start' }}>
        <ChildPanel name="Artin" panelId="artin-panel" scores={scores} weeklyScores={weeklyScores} todayScores={todayScores} history={history} dailyStates={dailyStates} avatar={avatars.Artin} onRecord={record} onUndo={undo} onReset={resetChild} onAvatarUpload={handleAvatarUpload} loading={saving} isAdmin={isAdmin} />
        <CenterPanel scores={scores} weeklyScores={weeklyScores} history={history} dailyStates={dailyStates} claimed={claimed} />
        <ChildPanel name="Aiden" panelId="aiden-panel" scores={scores} weeklyScores={weeklyScores} todayScores={todayScores} history={history} dailyStates={dailyStates} avatar={avatars.Aiden} onRecord={record} onUndo={undo} onReset={resetChild} onAvatarUpload={handleAvatarUpload} loading={saving} isAdmin={isAdmin} />
      </main>

      <footer style={{ textAlign: 'center', padding: 16, color: '#888', fontSize: '0.8rem' }}>‚òÅÔ∏è Synced with Google Sheets</footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
